# E2E Tests with Playwright

This directory contains comprehensive end-to-end tests for the Email Helper application using Playwright.

## 📁 Test Structure

```
frontend/tests/e2e/
├── fixtures/
│   └── test-setup.ts          # Test fixtures, mock data, and utilities
├── email-processing.spec.ts   # Email retrieval and classification tests
├── email-editing.spec.ts      # Email editing workflow tests
├── summary-generation.spec.ts # Summary generation tests
├── task-management.spec.ts    # Task creation and management tests
└── README.md                  # This file
```

## 🚀 Running Tests

### Prerequisites

1. **Install dependencies:**
   ```bash
   npm install
   ```

2. **Install Playwright browsers (first time only):**
   ```bash
   npx playwright install
   ```

### Running Tests

**Run all E2E tests:**
```bash
npm run test:e2e
```

**Run with UI mode (interactive):**
```bash
npm run test:e2e:ui
```

**Run in debug mode:**
```bash
npm run test:e2e:debug
```

**Run in headed mode (see browser):**
```bash
npm run test:e2e:headed
```

**View test report:**
```bash
npm run test:e2e:report
```

**Run specific test file:**
```bash
npx playwright test email-processing.spec.ts
```

**Run specific test:**
```bash
npx playwright test -g "should retrieve and display emails"
```

## 🧪 Test Coverage

### Email Processing Tests (`email-processing.spec.ts`)
- ✅ Email retrieval from backend
- ✅ AI classification of emails
- ✅ Batch processing operations
- ✅ Email filtering by category
- ✅ Email statistics display
- ✅ Pagination for large datasets
- ✅ Error handling (network errors, timeouts)
- ✅ Email detail navigation

### Email Editing Tests (`email-editing.spec.ts`)
- ✅ Mark emails as read/unread
- ✅ Update email categories
- ✅ Move emails to folders
- ✅ Bulk mark as read operations
- ✅ Bulk delete operations
- ✅ Add custom categories
- ✅ Search and filter emails
- ✅ Conflict handling
- ✅ Undo operations
- ✅ Batch category updates

### Summary Generation Tests (`summary-generation.spec.ts`)
- ✅ Generate summary for single email
- ✅ Action-required email summaries
- ✅ FYI email summaries
- ✅ Conversation thread summaries
- ✅ Batch summary generation
- ✅ Key points extraction
- ✅ Error handling for AI failures
- ✅ Summary caching
- ✅ Copy summary to clipboard
- ✅ Different summary lengths
- ✅ Action item highlighting

### Task Management Tests (`task-management.spec.ts`)
- ✅ Display task list
- ✅ Create task manually
- ✅ Create task from email
- ✅ Update task status
- ✅ Update task priority
- ✅ Delete tasks
- ✅ Filter by status/priority
- ✅ Search tasks
- ✅ Task statistics
- ✅ Link tasks to emails
- ✅ Drag and drop reordering
- ✅ Task completion
- ✅ Overdue task indicators
- ✅ Due date modification

## 🎭 Mock Data

Tests use mock data generated by fixtures in `fixtures/test-setup.ts`:

### Mock Emails
- 15 sample emails with varied content
- Categories: `required_personal_action`, `optional_fyi`, `team_discussion`, `task_delegation`
- Mix of read/unread status
- Realistic timestamps
- Conversation threading

### Mock Tasks
- 8 sample tasks
- Statuses: `pending`, `in_progress`, `completed`, `cancelled`
- Priorities: `low`, `medium`, `high`
- Some tasks linked to emails
- Due dates and creation timestamps

### Mock APIs
All backend API endpoints are mocked to provide:
- Email CRUD operations
- Task CRUD operations
- AI classification and summarization
- Batch processing
- Statistics and aggregations

## ⚙️ Configuration

Test configuration is in `playwright.config.ts`:

### Key Settings
- **Base URL:** `http://localhost:3000`
- **Workers:** 1 (for COM backend stability)
- **Retries:** 1 locally, 2 in CI
- **Timeout:** 60 seconds per test
- **Browser:** Chromium (Desktop Chrome)
- **Screenshots:** On failure only
- **Video:** Retain on failure
- **Trace:** On first retry

### Web Server
Tests automatically start the Vite dev server:
- Command: `npm run dev`
- URL: `http://localhost:3000`
- Timeout: 120 seconds to start
- Reuses existing server in development

## 🔧 Test Patterns

### Using Fixtures
```typescript
import { test, expect } from './fixtures/test-setup';

test('my test', async ({ page, mockEmails, mockEmailAPI }) => {
  await mockEmailAPI(page, mockEmails);
  // ... test code
});
```

### Available Fixtures
- `authenticatedPage` - Pre-authenticated page
- `mockEmails` - Array of mock email data
- `mockTasks` - Array of mock task data
- `mockEmailAPI` - Email API mocker function
- `mockTaskAPI` - Task API mocker function
- `mockAIAPI` - AI API mocker function
- `navigateToEmails` - Helper to navigate to emails page
- `navigateToTasks` - Helper to navigate to tasks page
- `navigateToProcessing` - Helper to navigate to processing page

### Resilient Selectors
Tests use multiple selector strategies to handle UI variations:
```typescript
// Try multiple selector approaches
const button = page.locator(
  'button:has-text("Create"), ' +
  'button[aria-label*="create"], ' +
  '[data-testid="create-button"]'
).first();
```

### Graceful Degradation
Tests skip when features are not available:
```typescript
if (await button.isVisible({ timeout: 3000 }).catch(() => false)) {
  // Run test
} else {
  test.skip();
}
```

## 🐛 Debugging

### View Test in Browser
```bash
npm run test:e2e:headed
```

### Step Through Tests
```bash
npm run test:e2e:debug
```

### View Trace
After a failed test, traces are captured. View them with:
```bash
npx playwright show-trace trace.zip
```

### Screenshots and Videos
On failure, screenshots and videos are saved to:
- `test-results/` - Test artifacts
- `playwright-report/` - HTML report

## 📊 CI Integration

Tests are configured for CI environments:
- Runs in headless mode
- 2 retries on failure
- Fails fast on `test.only`
- JSON and HTML reports generated
- Artifacts uploaded on failure

### GitHub Actions Example
```yaml
- name: Install Playwright
  run: npx playwright install --with-deps chromium

- name: Run E2E Tests
  run: npm run test:e2e

- name: Upload Report
  if: always()
  uses: actions/upload-artifact@v3
  with:
    name: playwright-report
    path: frontend/playwright-report/
```

## 🔍 Test Data Requirements

### Backend Mock Requirements
Tests mock the following API endpoints:
- `GET /api/emails` - Email list with pagination
- `GET /api/emails/:id` - Single email details
- `PATCH /api/emails/:id` - Update email
- `POST /api/emails/batch` - Batch operations
- `GET /api/emails/stats` - Email statistics
- `GET /api/tasks` - Task list
- `POST /api/tasks` - Create task
- `PATCH /api/tasks/:id` - Update task
- `DELETE /api/tasks/:id` - Delete task
- `GET /api/tasks/stats` - Task statistics
- `POST /api/ai/classify` - Classify email
- `POST /api/ai/summarize` - Generate summary
- `POST /api/processing/process-batch` - Batch processing

### Test User
Tests use a mock authenticated user:
- ID: `test-user-1`
- Email: `test@example.com`
- Name: `Test User`

## 🎯 Best Practices

1. **Use fixtures** for common setup and mock data
2. **Test user workflows**, not implementation details
3. **Handle async operations** with proper waits
4. **Test error scenarios** as well as success paths
5. **Use descriptive test names** that explain what's being tested
6. **Keep tests independent** - each test should run standalone
7. **Mock external dependencies** - don't rely on real backend/AI services
8. **Skip gracefully** when features are not yet implemented
9. **Use multiple selectors** for resilience against UI changes
10. **Document test data requirements** for maintainability

## 🚨 Troubleshooting

### Tests Timing Out
- Increase timeout in `playwright.config.ts`
- Check if backend server is starting properly
- Verify mock API routes are set up correctly

### Selectors Not Found
- Tests use resilient selectors with fallbacks
- Check if UI structure has changed
- Add new selector patterns to fixtures

### Tests Flaking
- Ensure proper `waitForTimeout` or `waitForLoadState` calls
- Use stable selectors (data-testid preferred)
- Run tests with `--headed` to see what's happening

### Mock Data Issues
- Verify mock data structure matches backend types
- Check API route patterns in fixtures
- Use browser DevTools to inspect network requests

## 📚 Additional Resources

- [Playwright Documentation](https://playwright.dev/)
- [Playwright Best Practices](https://playwright.dev/docs/best-practices)
- [Debugging Tests](https://playwright.dev/docs/debug)
- [Test Fixtures](https://playwright.dev/docs/test-fixtures)
- [Trace Viewer](https://playwright.dev/docs/trace-viewer)

## 🤝 Contributing

When adding new tests:
1. Follow existing patterns and fixtures
2. Add tests for both success and error scenarios
3. Use descriptive test names
4. Mock external dependencies
5. Document any new test data requirements
6. Update this README if adding new test categories
